#!/bin/bash

if [[ $OSTYPE == msys ]]; then
    /c/cygwin/bin/bash build/make-release $*
    exit $?
fi

VERSION_MAJOR=$1
VERSION_MINOR=$2
BINDIR=$3
RELEASE=$(date +%Y%m%d)
SCP="scp"
SFTP="sftp"

UNAME=$(uname -a)
case $UNAME in
    *x86_64*Linux)
        SYSTEM=linux-x86_64
        BINARY=cellml-sdk-$VERSION_MAJOR.$VERSION_MINOR-Linux-x86_64.tar.bz2
        BINFULL="$BINDIR/$BINARY"
        ;;
    *i686*Linux)
        SYSTEM=linux-x86
        BINARY=cellml-sdk-$VERSION_MAJOR.$VERSION_MINOR-Linux-i686.tar.bz2
        BINFULL="$BINDIR/$BINARY"
        ;;
    *i686*Cygwin)
        SYSTEM=win32
        BINARY=cellml-sdk-$VERSION_MAJOR.$VERSION_MINOR-Win32-MSVC10.exe
        BINFULL=$(cygpath "$BINDIR/$BINARY")
        BINARY2=cellml-sdk-$VERSION_MAJOR.$VERSION_MINOR-Win32-MSVC10.zip
        BINFULL2=$(cygpath "$BINDIR/$BINARY2")
        ;;
    *Msys*)
        SYSTEM=win32
        BINARY=cellml-sdk-$VERSION_MAJOR.$VERSION_MINOR-Win32-MingW.exe
        BINFULL=$(/bin/cygpath "$BINDIR/$BINARY")
        BINARY2=cellml-sdk-$VERSION_MAJOR.$VERSION_MINOR-Win32-MingW.zip
        BINFULL2=$(/bin/cygpath "$BINDIR/$BINARY2")
        SCP=/bin/scp.exe
        SFTP=/bin/sftp.exe
        ;;
    *Darwin*)
        SYSTEM=mac
        BINARY=cellml-sdk-$VERSION_MAJOR.$VERSION_MINOR-Mac.dmg
        BINFULL="$BINDIR/$BINARY"
        ;;
    default)
        echo "Fatal error - Cannot identify system to make release for from uname output ($UNAME)"
        exit 1
        ;;
esac

echo $SFTP cellml-buildbot,cellml-api@frs.sourceforge.net:/home/frs/project/c/ce/cellml-api/CellML-API-Nightly
$SFTP cellml-buildbot,cellml-api@frs.sourceforge.net:/home/frs/project/c/ce/cellml-api/CellML-API-Nightly <<END
mkdir $VERSION_MAJOR.$VERSION_MINOR
cd $VERSION_MAJOR.$VERSION_MINOR
mkdir $RELEASE
cd $RELEASE
mkdir src
mkdir linux-x86
mkdir linux-x86_64
mkdir win32
mkdir mac
END

# As a side effect of the linux-x86 build, release the source code...
if [[ $SYSTEM == linux-x86 ]];
then
    cd /tmp
    rm -fr package-src
    mkdir package-src
    cd package-src
    hg clone ssh://buildbot@bioeng1038//people/amil082/hgmirror/cellml-api cellml-api-$VERSION_MAJOR.$VERSION_MINOR
    # Note: --exclude is a GNU extension, but this only runs on GNU/Linux systems.
    tar --exclude .hg -cjf cellml-api-$VERSION_MAJOR.$VERSION_MINOR.tar.bz2 cellml-api-$VERSION_MAJOR.$VERSION_MINOR
    $SCP cellml-api-$VERSION_MAJOR.$VERSION_MINOR.tar.bz2 cellml-buildbot,cellml-api@frs.sourceforge.net:/home/frs/project/c/ce/cellml-api/CellML-API-Nightly/$VERSION_MAJOR.$VERSION_MINOR/$RELEASE/src/cellml-api-$VERSION_MAJOR.$VERSION_MINOR.tar.bz2
fi

echo $SCP "$BINFULL" "cellml-buildbot,cellml-api@frs.sourceforge.net:/home/frs/project/c/ce/cellml-api/CellML-API-Nightly/$VERSION_MAJOR.$VERSION_MINOR/$RELEASE/$SYSTEM/$BINARY"
$SCP "$BINFULL" "cellml-buildbot,cellml-api@frs.sourceforge.net:/home/frs/project/c/ce/cellml-api/CellML-API-Nightly/$VERSION_MAJOR.$VERSION_MINOR/$RELEASE/$SYSTEM/$BINARY"

if [[ $SYSTEM == win32 ]];
then
    $SCP "$BINFULL2" "cellml-buildbot,cellml-api@frs.sourceforge.net:/home/frs/project/c/ce/cellml-api/CellML-API-Nightly/$VERSION_MAJOR.$VERSION_MINOR/$RELEASE/$SYSTEM/$BINARY2"
fi
